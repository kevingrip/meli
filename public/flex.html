<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="./styles.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>

<body>
    <h1 style="display: flex; justify-content: center; align-items: center; margin:20px">ORDENES FLEX</h1>
    <div id="ordenes"></div>
    <div style="display: flex; justify-content: center; align-items: center" id="cargando">
        <h3>Cargando...</h3>
    </div>

    <script>
        fetch('/flex')
            .then(response => response.json())
            .then(result => {
                const data = result.dataFlex
                const count = result.counts


                document.getElementById("cargando").remove()
                const ordenes = document.getElementById("ordenes")

                const buttonTodas = document.createElement('a')
                buttonTodas.textContent="TODAS"
                buttonTodas.href='http://localhost:3000/index.html'

                const divFlex = document.createElement('div')

                const divBeigeFlex = document.createElement('div')
                const divBeigeNombreFlex = document.createElement('div')
                const divBeigeNumeroFlex = document.createElement('div')
                divBeigeNombreFlex.textContent= `Beige`
                divBeigeNumeroFlex.textContent= `${count.flex.Beige || 0}`
                divBeigeFlex.appendChild(divBeigeNombreFlex)
                divBeigeFlex.appendChild(divBeigeNumeroFlex)
                divBeigeFlex.classList.add('divResumen')
                divBeigeNombreFlex.classList.add('divResumenNombre')
                divBeigeNumeroFlex.classList.add('divResumenNumero')

                const divGrisOscuroFlex = document.createElement('div')
                const divGrisOscuroNombreFlex = document.createElement('div')
                const divGrisOscuroNumeroFlex = document.createElement('div')
                divGrisOscuroNombreFlex.textContent= `Gris Oscuro`
                divGrisOscuroNumeroFlex.textContent= `${count.flex["Gris oscuro"] || 0}`
                divGrisOscuroFlex.appendChild(divGrisOscuroNombreFlex)
                divGrisOscuroFlex.appendChild(divGrisOscuroNumeroFlex)
                divGrisOscuroFlex.classList.add('divResumen')
                divGrisOscuroNombreFlex.classList.add('divResumenNombre')
                divGrisOscuroNumeroFlex.classList.add('divResumenNumero')

                const divgrisClaroFlex = document.createElement('div')
                const divGrisClaroNombreFlex = document.createElement('div')
                const divGrisClaroNumeroFlex = document.createElement('div')
                divGrisClaroNombreFlex.textContent= `Gris Claro`
                divGrisClaroNumeroFlex.textContent= `${count.flex["Gris Claro"] || 0}`
                divgrisClaroFlex.appendChild(divGrisClaroNombreFlex)
                divgrisClaroFlex.appendChild(divGrisClaroNumeroFlex)
                divgrisClaroFlex.classList.add('divResumen')
                divGrisClaroNombreFlex.classList.add('divResumenNombre')
                divGrisClaroNumeroFlex.classList.add('divResumenNumero')

                const divNegroFlex = document.createElement('div')
                const divNegroNombreFlex = document.createElement('div')
                const divNegroNumeroFlex = document.createElement('div')
                divNegroNombreFlex.textContent= `Negro`
                divNegroNumeroFlex.textContent= `${count.flex.Negro || 0}`
                divNegroFlex.appendChild(divNegroNombreFlex)
                divNegroFlex.appendChild(divNegroNumeroFlex)
                divNegroFlex.classList.add('divResumen')
                divNegroNombreFlex.classList.add('divResumenNombre')
                divNegroNumeroFlex.classList.add('divResumenNumero')

                divBeigeNombreFlex.classList.add('colorBeige')
                divGrisOscuroNombreFlex.classList.add('colorGrisOscuro')
                divGrisClaroNombreFlex.classList.add('colorGrisClaro')
                divNegroNombreFlex.classList.add('colorNegro')


                divFlex.appendChild(divBeigeFlex)
                divFlex.appendChild(divGrisOscuroFlex)
                divFlex.appendChild(divgrisClaroFlex)
                divFlex.appendChild(divNegroFlex)

                buttonTodas.classList.add("divTitle")

                const divEnvios = document.createElement('div')
                // divEnvios.appendChild(divTipoCorreo)
                // divEnvios.appendChild(divCorreo)
                // divEnvios.appendChild(divTipoFlex)
                divEnvios.appendChild(divFlex)

                divFlex.classList.add("divCounts")
                ordenes.appendChild(buttonTodas)
                ordenes.appendChild(divEnvios)

                const allCoordenadas = data.filter(element => element.shipping_info.substatus === 'ready_to_print' || element.shipping_info.substatus === 'printed').map((item) => (item.shipping_info.receiver_address.address_line+','+item.shipping_info.receiver_address.city.name))
                const allCordenadasToString = allCoordenadas.join('/')

                const allOrdersToMap = `https://www.google.com/maps/dir//${allCordenadasToString}/`

                console.log(allOrdersToMap)



                data.forEach(element => {
                    const bloquePadre = document.createElement('div')
                    const bloqueSubPadre = document.createElement('div') //bloque donde estan data,envio,product juntos y se agrega descarga
                    const bloqueData = document.createElement('div')
                    const bloqueEnvio = document.createElement('div')
                    const bloqueProduct = document.createElement('div')
                    const bloqueDescarga = document.createElement('div')
                    const buttonDescarga = document.createElement('button')
                    const OrderBloque = document.createElement('div')
                    const OrderData = document.createElement('div')
                    const ventaId = document.createElement('p')
                    const orderId = document.createElement('p')
                    const Client = document.createElement('p')
                    const Seller = document.createElement('h2')
                    const idShipping = document.createElement('p')
                    const dateCreated = document.createElement('p')
                    const dataStatus = document.createElement('p')
                    const dataSubstatus = document.createElement('p')
                    const ShippingType = document.createElement('h2')
                    const ShippingMap = document.createElement('p')
                    const ShippingComment = document.createElement('p')
                    const ShippingLabelStatus = document.createElement('p')
                    const ShippingLastTime = document.createElement('p')
                    const link = document.createElement('a');
                    const title = document.createElement('p')
                    const quantity = document.createElement('p')
                    const color = document.createElement('p')
                    const sector = document.createElement('p')
                    const direccion = document.createElement('p')

                    var tipoEnvio;
                    if (element.shipping_info.logistic_type === 'self_service') {
                        tipoEnvio = 'FLEX'
                        direccion.textContent = `Direccion: ${element.shipping_info.receiver_address.address_line},${element.shipping_info.receiver_address.city.name}`
                        link.href = element.maps
                        link.target = '_blank';
                        link.textContent = "Ver direccion 📍"
                    } else if (element.shipping_info.logistic_type === 'drop_off') {
                        tipoEnvio = 'CORREO ARGENTINO'

                    } else if (element.shipping_info.logistic_type === 'xd_drop_off') {
                        tipoEnvio = 'PUNTO DE DESPACHO'
                    } else {
                        tipoEnvio = element.shipping_info.status
                    }

                    ventaId.textContent = `ID: #${element.ventaid}`
                    orderId.textContent = `orden: ${element.id}`
                    Client.textContent = `Cliente: ${element.buyer.nickname}`
                    Seller.textContent = `${element.seller.nickname}`
                    idShipping.textContent = `ID: ${element.shipping.id}`
                    dateCreated.textContent = `Fecha: ${new Date(element.date_created).toLocaleString()}`
                    dataStatus.textContent = `Status: ${element.shipping_info.status}`
                    ShippingComment.textContent = `Comentarios: ${element.shipping_info.receiver_address.comment}` 
                    ShippingLabelStatus.textContent = `Estado: ${element.shipping_info.statusLabel}`
                    ShippingLastTime.textContent = `Despachar antes de: ${new Date(element.shipping_info.lastTimeToSend).toLocaleString()}`
                    ShippingType.textContent = tipoEnvio
                    sector.textContent = `Sector: ${element.shipping_info?.receiver_address?.state.name || 'No disponible'}`


                    const variantes = []
                    element.orderItemNuevo.forEach(orderItem => {
                        const divProduct = document.createElement('div')
                        const quantity = document.createElement('p')
                        const color = orderItem.item.variation_attributes?.[0]?.value_name || null
                        if (color === 'Gris Claro' || orderItem.item.id === "MLA2097220912") {
                            divProduct.classList.add("productGrisClaro","colorGrisClaro")
                            var colorBrev = "CL"
                        } else if (color === 'Gris oscuro' || orderItem.item.id === "MLA2097220910") {
                            divProduct.classList.add("productGrisOscuro","colorGrisOscuro")
                            colorBrev = "OS"
                        } else if (color === 'Beige' || orderItem.item.id === "MLA2097220908") {
                            divProduct.classList.add("productBeige","colorBeige")
                            colorBrev = "BG"
                        } else if (color === 'Negro' || orderItem.item.id === "MLA2104745370") {
                            divProduct.classList.add("productNegro","colorNegro")
                            colorBrev = "NG"
                        } else if (orderItem.item.id === 'MLA1500334145') {
                            divProduct.classList.add("productPajaro")
                            colorBrev = "PAJARO"
                        } else {
                            divProduct.classList.add("productSC")
                        }

                        variantes.push(`${colorBrev} x${orderItem.quantity}`)
                        quantity.textContent = `x${orderItem.quantity}`
                        divProduct.appendChild(quantity)
                        bloqueProduct.appendChild(divProduct)
                    })
                    title.textContent = `${element.order_items[0].item.title}`
                    buttonDescarga.textContent = '>'
                    const variantesSTR = variantes.join(", ")
                    buttonDescarga.addEventListener("click", async () => {
                        const bodyData = {
                            usuario: element.seller.nickname,
                            id: element.shipping.id,
                            variantes: variantesSTR
                        }
                        try {
                            const peticionEtiqueta = await axios.post('/etiqueta', bodyData)
                            if (peticionEtiqueta.data.success) {
                                alert("Etiqueta generada correctamente.");
                            } else {
                                alert("Error al generar la etiqueta.");
                            }
                        } catch (error) {
                            console.error("Error al enviar solicitud al backend:", error);
                        }
                    })



                    ShippingMap.appendChild(link)

                    bloqueData.appendChild(Seller)
                    bloqueData.appendChild(ventaId)
                    bloqueData.appendChild(title)
                    bloqueData.appendChild(Client)
                    bloqueData.appendChild(dateCreated)
                    bloqueData.appendChild(dataStatus)
                    bloqueData.appendChild(orderId)
                    element.paymentsOriginales.forEach(pays => {
                        const paymentId = document.createElement('p')
                        paymentId.textContent = `payments: ${pays}`;
                        bloqueData.appendChild(paymentId)
                    })

                    bloqueEnvio.appendChild(ShippingType)
                    bloqueEnvio.appendChild(idShipping)


                    if (element.shipping_info.substatus === 'ready_to_print' || element.shipping_info.substatus === 'printed') {
                        bloqueDescarga.appendChild(buttonDescarga)                        
                    } else {
                        if (element.shipping_info.status === 'delivered') {
                            bloquePadre.classList.add("bloquePadreDelivered")
                        } else if (element.shipping_info.status === 'cancelled') {
                            bloquePadre.classList.add("bloquePadreCancelled")
                        } else if (element.shipping_info.status === 'pending') {
                            bloquePadre.classList.add("bloquePadrePending")
                        } else {
                            bloquePadre.classList.add("bloquePadreInComing")
                        }
                    }

                    bloqueEnvio.appendChild(ShippingLastTime)
                    bloqueEnvio.appendChild(sector)
                    bloqueEnvio.appendChild(direccion)
                    bloqueEnvio.appendChild(ShippingMap)

                    if (element.shipping_info.substatus) {
                        bloqueEnvio.appendChild(ShippingComment)
                    }


                    bloqueData.classList.add("bloqueData")
                    bloqueEnvio.classList.add("bloqueEnvio")
                    bloqueProduct.classList.add("bloqueProduct")
                    bloqueDescarga.classList.add("bloqueDescarga")

                    if (element.shipping_info.logistic_type === 'self_service' && element.shipping_info.substatus === 'ready_to_print') {
                        buttonDescarga.classList.add("buttonDescargaFlexRTP")
                    } else if (element.shipping_info.logistic_type === 'self_service' && element.shipping_info.substatus === 'printed') {
                        buttonDescarga.classList.add("buttonDescargaFlexPTD")
                    } else if ((element.shipping_info.logistic_type === 'drop_off' || element.shipping_info.logistic_type === 'xd_drop_off') && element.shipping_info.substatus === 'ready_to_print') {
                        buttonDescarga.classList.add("buttonDescargaCorreoRTP")
                    } else if ((element.shipping_info.logistic_type === 'drop_off' || element.shipping_info.logistic_type === 'xd_drop_off') && element.shipping_info.substatus === 'printed') {
                        buttonDescarga.classList.add("buttonDescargaCorreoPTD")
                    }


                    buttonDescarga.classList.add("buttonDescarga")
                    bloquePadre.classList.add("bloquePadreStyle")

                    OrderBloque.classList.add("OrderBloque")
                    OrderData.appendChild(bloqueData)
                    OrderData.appendChild(bloqueProduct)
                    OrderData.classList.add("orderData")
                    OrderBloque.appendChild(OrderData)
                    OrderBloque.appendChild(bloqueEnvio)

                    bloqueSubPadre.appendChild(OrderBloque)
                    bloqueSubPadre.appendChild(bloqueDescarga)
                    bloqueSubPadre.classList.add("subBloque")
                    bloquePadre.appendChild(bloqueSubPadre)
                    ordenes.classList.add("orden")
                    ordenes.appendChild(bloquePadre)
                    // console.dir(element, { depth: null })
                });
            })
            .catch(error => {
                const cargando = document.getElementById("cargando");
                if (cargando) cargando.remove();
                const ordenes = document.getElementById("ordenes")
                const mesaggeError = document.createElement("p")
                mesaggeError.innerHTML = `Error al cargar la pagina: ${error}`
                ordenes.appendChild(mesaggeError)
            })
    </script>


</body>

</html>